create or replace PACKAGE REALTIME AS

  /* TODO enter package declarations (types, exceptions, methods etc) here */
    PROCEDURE PROCESS_OUTAGES;

END REALTIME;

create or replace
PACKAGE BODY REALTIME AS

  /* TODO enter package declarations (types, exceptions, methods etc) here */
PROCEDURE PROCESS_OUTAGES
IS
sql_stmt varchar2(4000);
BEGIN

delete from webr.pge_outagexfmr;
insert into webr.pge_outagexfmr(OUTAGE_NO,XFMR_GUID,XFMR_ID,CUST_AFF,ESSENTIAL_CUST_AFF,CRITICAL_CUST_AFF,XFMR_KEY,XFMR_INT_ID,DISTRICT_NAME,FEEDER_ID,FEEDER_DESC,ETOR,OUTAGE_START_TIME,OIS_IVR_CAUSE_DESC,OUTAGE_LEVEL,OUTAGE_STATUS,CREW_STATUS_DESC,CUR_CUST_AFF,EQUIP_GUID,EQUIP_TYPE,EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC,LATITUDE,LONGITUDE,SHAPE) select OUTAGE_NO,XFMR_GUID,XFMR_ID,CUST_AFF,ESSENTIAL_CUST_AFF,CRITICAL_CUST_AFF,XFMR_KEY,XFMR_INT_ID,DISTRICT_NAME,FEEDER_ID,FEEDER_DESC,ETOR,OUTAGE_START_TIME,OIS_IVR_CAUSE_DESC,OUTAGE_LEVEL,OUTAGE_STATUS,CREW_STATUS_DESC,CUR_CUST_AFF,EQUIP_GUID,EQUIP_TYPE,EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC,LATITUDE,LONGITUDE,SHAPE from webr.pge_outagexfmr_spvw;

-- Issue with indexes https://geonet.esri.com/thread/68882 - make sure no index on outagepoly
--execute immediate sql_stmt;
delete from webr.pge_outagepoly;
sql_stmt:='insert into webr.pge_outagepoly(OUTAGE_NO,DISTRICT_NAME,FEEDER_ID,FEEDER_DESC,ETOR,OUTAGE_START_TIME,OIS_IVR_CAUSE_DESC,OUTAGE_LEVEL,OUTAGE_STATUS,CREW_STATUS_DESC,CUR_CUST_AFF,EQUIP_GUID,EQUIP_TYPE,EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC,shape) select lvl3.OUTAGE_NO,lvl3.DISTRICT_NAME,lvl3.FEEDER_ID,lvl3.FEEDER_DESC,lvl3.ETOR,lvl3.OUTAGE_START_TIME,lvl3.OIS_IVR_CAUSE_DESC,lvl3.OUTAGE_LEVEL,lvl3.OUTAGE_STATUS,lvl3.CREW_STATUS_DESC,lvl3.CUR_CUST_AFF,lvl3.EQUIP_GUID,lvl3.EQUIP_TYPE,lvl3.EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC, sde.st_aggr_convexhull(sde.st_buffer(shape,0.0004)) as shape from webr.pge_outagenotifxfmr_vw  lvl3 where lvl3.OUTAGE_NO in (select lvl1.OUTAGE_NO from webr.pge_outagenotifxfmr_vw lvl1 group by lvl1.OUTAGE_NO,lvl1.DISTRICT_NAME,lvl1.FEEDER_ID,lvl1.FEEDER_DESC,lvl1.ETOR,lvl1.OUTAGE_START_TIME,lvl1.OIS_IVR_CAUSE_DESC, lvl1.OUTAGE_LEVEL,lvl1.OUTAGE_STATUS,lvl1.CREW_STATUS_DESC,lvl1.CUR_CUST_AFF,lvl1.EQUIP_GUID,lvl1.EQUIP_TYPE,lvl1.EQUIP_NAME, lvl1.EQUIP_CAT,lvl1.HAZARD_LEVEL_CODE,lvl1.HAZARD_LEVEL_DESC  having count(outage_no) < 3) group by lvl3.OUTAGE_NO,lvl3.DISTRICT_NAME,lvl3.FEEDER_ID,lvl3.FEEDER_DESC,lvl3.ETOR,lvl3.OUTAGE_START_TIME,lvl3.OIS_IVR_CAUSE_DESC, lvl3.OUTAGE_LEVEL,lvl3.OUTAGE_STATUS,lvl3.CREW_STATUS_DESC,lvl3.CUR_CUST_AFF,lvl3.EQUIP_GUID,lvl3.EQUIP_TYPE,lvl3.EQUIP_NAME, lvl3.EQUIP_CAT,lvl3.HAZARD_LEVEL_CODE,lvl3.HAZARD_LEVEL_DESC';
execute immediate sql_stmt;
sql_stmt:='insert into webr.pge_outagepoly(OUTAGE_NO,DISTRICT_NAME,FEEDER_ID,FEEDER_DESC,ETOR,OUTAGE_START_TIME,OIS_IVR_CAUSE_DESC,OUTAGE_LEVEL,OUTAGE_STATUS,CREW_STATUS_DESC,CUR_CUST_AFF,EQUIP_GUID,EQUIP_TYPE,EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC,shape) select OUTAGE_NO,DISTRICT_NAME,FEEDER_ID,FEEDER_DESC,ETOR,OUTAGE_START_TIME,OIS_IVR_CAUSE_DESC,OUTAGE_LEVEL,OUTAGE_STATUS,CREW_STATUS_DESC,CUR_CUST_AFF,EQUIP_GUID,EQUIP_TYPE,EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC, sde.ST_ConvexHull(sde.ST_Aggr_Union(shape)) as shape from webr.pge_outagenotifxfmr_vw group by outage_no,DISTRICT_NAME,FEEDER_ID,FEEDER_DESC,ETOR,OUTAGE_START_TIME,OIS_IVR_CAUSE_DESC,OUTAGE_LEVEL,OUTAGE_STATUS,CREW_STATUS_DESC,CUR_CUST_AFF,EQUIP_GUID,EQUIP_TYPE,EQUIP_NAME,EQUIP_CAT,HAZARD_LEVEL_CODE,HAZARD_LEVEL_DESC having count(outage_no) > 2';
execute immediate sql_stmt;

   
END PROCESS_OUTAGES;
END REALTIME;
