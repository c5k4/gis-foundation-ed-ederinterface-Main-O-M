--------------------------------------------------------
--  DDL for Procedure UPDATE_NULLINSTALLATIONTYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "EDGIS"."UPDATE_NULLINSTALLATIONTYPE" 
IS
  -- VARIABLES
  regid     NUMBER(10);
  sqlstmt1  VARCHAR2(30000);
  atable_OP VARCHAR2(60);
  atable_FI VARCHAR2(60);
BEGIN
  -- FAULTINDICATOR /SUPPORTSTRUCTURE
  MERGE INTO EDGIS.FAULTINDICATOR S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_SupportStructure
  WHERE GLOBALID IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_FAULTINDICATOR
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'OH',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- OPENPOINT /SUPPORTSTRUCTURE
  MERGE INTO EDGIS.OPENPOINT S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_SupportStructure
  WHERE GLOBALID IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_OPENPOINT
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'OH',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- FAULTINDICATOR /DEVICEGROUP FOR SUBTYPECD 1 OH
  MERGE INTO EDGIS.FAULTINDICATOR S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_DEVICEGROUP
  WHERE SUBTYPECD = 1
  AND GLOBALID   IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_FAULTINDICATOR
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'OH',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- OPENPOINT /DEVICEGROUP FOR SUBTYPECD 1 OH
  MERGE INTO EDGIS.OPENPOINT S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_DEVICEGROUP
  WHERE SUBTYPECD = 1
  AND GLOBALID   IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_OPENPOINT
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'OH',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- FAULTINDICATOR /DEVICEGROUP FOR SUBTYPECD 2 SUB
  MERGE INTO EDGIS.FAULTINDICATOR S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_DEVICEGROUP
  WHERE SUBTYPECD = 2
  AND GLOBALID   IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_FAULTINDICATOR
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'SUB',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- OPENPOINT /DEVICEGROUP FOR SUBTYPECD 2 SUB
  MERGE INTO EDGIS.OPENPOINT S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_DEVICEGROUP
  WHERE SUBTYPECD = 2
  AND GLOBALID   IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_OPENPOINT
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'SUB',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- FAULTINDICATOR /DEVICEGROUP FOR SUBTYPECD 3 PAD
  MERGE INTO EDGIS.FAULTINDICATOR S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_DEVICEGROUP
  WHERE SUBTYPECD = 3
  AND GLOBALID   IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_FAULTINDICATOR
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'PAD',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- OPENPOINT /DEVICEGROUP FOR SUBTYPECD 3 PAD
  MERGE INTO EDGIS.OPENPOINT S USING
  (SELECT GlobalID
  FROM EDGIS.ZZ_MV_DEVICEGROUP
  WHERE SUBTYPECD = 3
  AND GLOBALID   IN
    (SELECT STRUCTUREGUID
    FROM EDGIS.ZZ_MV_OPENPOINT
    WHERE INSTALLATIONTYPE IS NULL
    )
  ) U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
  UPDATE
  SET S.INSTALLATIONTYPE = 'PAD',
    S.DATEMODIFIED       =SYSDATE,
    S.LASTUSER           = 'SYNC' ;
  -- GET A TABLE FOR FAULTINDICATOR
  SELECT registration_id
  INTO regid
  FROM sde.table_registry
  WHERE table_name= 'FAULTINDICATOR';
  atable_FI      := 'EDGIS.A'|| regid;
  -- GET A TABLE FOR OPENPOINT
  SELECT registration_id
  INTO regid
  FROM sde.table_registry
  WHERE table_name= 'OPENPOINT';
  atable_OP      := 'EDGIS.A'|| regid;
  -- UPDATE A TABLE FAULTINDICATOR /SUPPORTSTRUCTURE
  sqlstmt1:= 'MERGE INTO '||atable_FI||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_SupportStructure WHERE GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_FAULTINDICATOR WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''OH'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE OPENPOINT /SUPPORTSTRUCTURE
  sqlstmt1:= 'MERGE INTO '||atable_OP||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_SupportStructure WHERE GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_OPENPOINT WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''OH'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE FAULTINDICATOR /DEVICEGROUP FOR SUBTYPECD 1 OH
  sqlstmt1:= 'MERGE INTO '||atable_FI||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_DEVICEGROUP WHERE SUBTYPECD = 1 and GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_FAULTINDICATOR WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''OH'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE OPENPOINT /DEVICEGROUP FOR SUBTYPECD 1 OH
  sqlstmt1:= 'MERGE INTO '||atable_OP||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_DEVICEGROUP WHERE SUBTYPECD = 1 and GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_OPENPOINT WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''OH'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE FAULTINDICATOR /DEVICEGROUP FOR SUBTYPECD 2 SUB
  sqlstmt1:= 'MERGE INTO '||atable_FI||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_DEVICEGROUP WHERE SUBTYPECD = 2 and GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_FAULTINDICATOR WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''SUB'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE OPENPOINT /DEVICEGROUP FOR SUBTYPECD 2 SUB
  sqlstmt1:= 'MERGE INTO '||atable_OP||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_DEVICEGROUP WHERE SUBTYPECD = 2 and GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_OPENPOINT WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''SUB'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE OPENPOINT /DEVICEGROUP FOR SUBTYPECD 3 PAD
  sqlstmt1:= 'MERGE INTO '||atable_OP||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_DEVICEGROUP WHERE SUBTYPECD = 3 and GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_OPENPOINT WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''PAD'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  -- UPDATE A TABLE FAULTINDICATOR /DEVICEGROUP FOR SUBTYPECD 3 PAD
  sqlstmt1:= 'MERGE INTO '||atable_FI||' S USING
(SELECT GlobalID from EDGIS.ZZ_MV_DEVICEGROUP WHERE SUBTYPECD = 3 and GLOBALID IN (
SELECT STRUCTUREGUID FROM EDGIS.ZZ_MV_FAULTINDICATOR WHERE INSTALLATIONTYPE IS NULL)
)  U ON (S.StructureGUID = U.GLOBALID)
WHEN MATCHED THEN
UPDATE
SET S.INSTALLATIONTYPE = ''PAD'',
S.DATEMODIFIED = SYSDATE,
S.LASTUSER     = ''SYNC'' ';
  EXECUTE immediate sqlstmt1;
  COMMIT;
  dbms_output.enable(NULL);
  -- PRINT OUTPUT FOR FAULTINDICATOR
  FOR v_reg IN
  (SELECT globalid FROM EDGIS.ZZ_MV_FAULTINDICATOR WHERE lastuser='SYNC'
  )
  LOOP
    dbms_output.put_line(v_reg.globalid||',EDGIS.FAULTINDICATOR'); --PRINT OUTPUT
  END LOOP;
  -- PRINT OUTPUT FOR OPENPOINT
  FOR v_reg IN
  (SELECT globalid FROM EDGIS.ZZ_MV_OPENPOINT WHERE lastuser='SYNC'
  )
  LOOP
    dbms_output.put_line(v_reg.globalid||',EDGIS.OPENPOINT'); --PRINT OUTPUT
  END LOOP;
EXCEPTION
WHEN OTHERS THEN
  Dbms_output.put_line(sqlerrm ||' error occured with this error code '||SQLCODE);
  ROLLBACK;
END UPDATE_NULLINSTALLATIONTYPE;
